name: $(BuildID)

trigger:
  - master

pr: none

variables:
  DockerImage: dixaba/test

jobs:
  - job: big
    timeoutInMinutes: 0
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: Docker@1
      displayName: 'docker login'
      inputs:
        containerregistrytype: 'Container Registry'
        dockerRegistryEndpoint: 'Docker Hub'
        command: login

    - task: Bash@3
      displayName: 'build.sh base'
      inputs:
        targetType: filePath
        filePath: ./build.sh
        arguments: big
        workingDirectory: '$(Build.SourcesDirectory)'

    - task: Docker@1
      displayName: 'docker push'
      inputs:
        containerregistrytype: 'Container Registry'
        dockerRegistryEndpoint: 'Docker Hub'
        command: 'Push an image'
        imageName: $(DockerImage)


  - job: latest
    timeoutInMinutes: 0
    dependsOn:
    - big
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: Docker@1
      displayName: 'docker login'
      inputs:
        containerregistrytype: 'Container Registry'
        dockerRegistryEndpoint: 'Docker Hub'
        command: login

    - task: Bash@3
      displayName: 'build.sh base'
      inputs:
        targetType: filePath
        filePath: ./build.sh
        arguments: latest
        workingDirectory: '$(Build.SourcesDirectory)'

    - task: Docker@1
      displayName: 'docker push'
      inputs:
        containerregistrytype: 'Container Registry'
        dockerRegistryEndpoint: 'Docker Hub'
        command: 'Push an image'
        imageName: $(DockerImage)


  - job: latestx64
    timeoutInMinutes: 0
    dependsOn:
    - big
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: Docker@1
      displayName: 'docker login'
      inputs:
        containerregistrytype: 'Container Registry'
        dockerRegistryEndpoint: 'Docker Hub'
        command: login
    
    - task: Bash@3
      displayName: 'build.sh base'
      inputs:
        targetType: filePath
        filePath: ./build.sh
        arguments: latest-x64
        workingDirectory: '$(Build.SourcesDirectory)'

    - task: Docker@1
      displayName: 'docker push'
      inputs:
        containerregistrytype: 'Container Registry'
        dockerRegistryEndpoint: 'Docker Hub'
        command: 'Push an image'
        imageName: $(DockerImage)


  - job: both
    timeoutInMinutes: 0
    dependsOn:
    - latest
    - latestx64
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: Docker@1
      displayName: 'docker login'
      inputs:
        containerregistrytype: 'Container Registry'
        dockerRegistryEndpoint: 'Docker Hub'
        command: login
    
    - task: Bash@3
      displayName: 'build.sh base'
      inputs:
        targetType: filePath
        filePath: ./build.sh
        arguments: both
        workingDirectory: '$(Build.SourcesDirectory)'

    - task: Docker@1
      displayName: 'docker push'
      inputs:
        containerregistrytype: 'Container Registry'
        dockerRegistryEndpoint: 'Docker Hub'
        command: 'Push an image'
        imageName: $(DockerImage)